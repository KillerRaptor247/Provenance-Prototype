!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lz-string"),require("mobx"),require("deep-diff")):"function"==typeof define&&define.amd?define(["exports","lz-string","mobx","deep-diff"],e):e((t=t||self).trrack={},t.LZString,t.mobx,t.DeepDiff)}(this,(function(t,e,n,r){"use strict";function o(){return(o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function a(t){return"parent"in t&&"state"in t}function i(t){return"parent"in t}function c(t,e){if(function(t){return"Root"===t.label}(e)||a(e))return n.toJS(e.state);var o=n.toJS(t.nodes[e.lastStateNode].state),i=JSON.parse(JSON.stringify(o));return e.diffs.forEach((function(t){r.applyChange(i,null,t)})),i}function u(t){var e=JSON.stringify(t);return JSON.parse(e,(function(t,e){return e?e.type&&"Set"===e.type?new Set(e.arr):e.type&&"Map"===e.type?new Map(Object.entries(e.obj)):e:e}))}function s(t){if(!t)return{};var e=JSON.stringify(n.toJS(t),(function(t,e){return e instanceof Set?{type:"Set",arr:Array.from(e)}:e instanceof Map?{type:"Map",obj:Object.fromEntries(e)}:e}));return JSON.parse(e)}function d(){return(new Date).getTime()}function f(){var t=(new Date).getTime();return t+=(new Date).valueOf(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)}))}function l(t,e,n,r,a,i){return{id:f(),label:n,metadata:o({createdOn:d(),eventType:a},i),artifacts:{annotations:[],customArtifacts:[]},parent:t,children:[],state:e,actionType:r,bookmarked:!1}}var p=n.action((function(t,e){var n=t.nodes[e];if(!n)throw new Error("Node with id: "+e+" does not exist");t.current=n.id})),h=n.action((function(t,e,n,a,u){var s=t,p=s.current,h=s.nodes[p],v=null,g=null;"diffs"in h?(v=c(s,s.nodes[h.lastStateNode]),g=h.lastStateNode):(v=c(s,h),g=h.id);var m=i(h),y=e.apply(n,u),S=y.stateSaveMode,b=y.actionType,x=y.label,w=y.eventType,O=y.meta,A=s.current,k=a(y.state),N=r.diff(v,k)||[];m&&Object.keys(v).length/2<N.length&&(m=!1);var J=(m=m&&"Diff"===S)?function(t,e,n,r,a,i,c){return{id:f(),label:e,metadata:o({createdOn:d(),eventType:i},c),artifacts:{annotations:[],customArtifacts:[]},parent:t,children:[],lastStateNode:a,diffs:n,actionType:r,bookmarked:!1}}(A,x,N,b,g,w,O):l(A,k,x,b,w,O);return s.nodes[J.id]=J,s.nodes[p].children.push(J.id),s.current=J.id,s.nodes[s.current]})),v=n.action((function(t,e){var n=l(t.current,e,"Import","Regular",null,{});t.nodes[n.id]=n,t.current=n.id}));n.configure({enforceActions:"always",isolateGlobalState:!0}),t.createAction=function(t){var e,r,o="Regular",a="Diff",i={},c=function(){for(var c=arguments.length,u=new Array(c),s=0;s<c;s++)u[s]=arguments[s];return{apply:n.action((function(c,s){if(!e)throw new Error("Please specify a default label when you create the action");return s||(s=e),t.apply(void 0,[c].concat(u)),{state:n.toJS(c),label:s,stateSaveMode:a,actionType:o,eventType:r,meta:i}}))}};return c.setLabel=function(t){return e=t,this},c.setActionType=function(t){return o=t,this},c.saveStateMode=function(t){return a=t,this},c.setEventType=function(t){return r=t,this},c.setMetaData=function(t){return i=t,this},c},t.getState=c,t.initProvenance=function(t,r){void 0===r&&(r={});var a=o({loadFromUrl:!1,firebaseConfig:null,_serializer:void 0,_deserializer:void 0},r),l=!1,g=a.loadFromUrl,m=a._serializer,y=a._deserializer,S=void 0!==m?m:s,b=void 0!==y?y:u,x=function(t,e){var r,o,a;return n.makeAutoObservable((r=e(t),{nodes:(o={},o[(a={id:f(),label:"Root",metadata:{createdOn:d(),eventType:"Root"},children:[],state:r,actionType:"Regular",bookmarked:!1}).id]=a,o),root:a.id,current:a.id}))}(t,S),w=n.computed((function(){return b(c(x,x.nodes[x.current]))}));return g&&n.reaction((function(){return w.get()}),(function(t){var n=new URL(window.location.href),r=new URLSearchParams(n.search),o=e.compressToEncodedURIComponent(JSON.stringify(S(t)));r.set("provState",o),window.history.replaceState({},"",n.pathname+"?"+r)})),{get state(){return w.get()},get config(){return a},get graph(){return x},get current(){return x.nodes[x.current]},get root(){return x.nodes[x.root]},get usingDefaultSerializer(){return void 0===m&&void 0===y},apply:function(t,e){if(!l)throw new Error("Provenance setup not finished. Please call done function on provenance object after setting up any observers.)");h(x,t,w.get(),S,e)},addGlobalObserver:function(t){n.reaction((function(){return n.toJS(x)}),(function(e,n){var r="Any";Object.keys(e.nodes).length>Object.keys(n.nodes).length?r="NodeAdded":e.current!==n.current&&(r="CurrentChanged"),t(e,r)}))},addObserver:function(t,e){n.reaction((function(){return t(w.get())}),(function(t,n){return e(t,n)}))},goToNode:function(t){p(x,t)},addArtifact:n.action("Add Artifact Action",(function(t,e){var n=x.current;e&&(n=e);var r=x.nodes[n];i(r)&&r.artifacts.customArtifacts.push({timestamp:d(),artifact:t})})),addAnnotation:n.action("Add Annotation Action",(function(t,e){var n=x.current;e&&(n=e);var r=x.nodes[n];i(r)&&r.artifacts.annotations.push({timestamp:d(),annotation:t})})),getAllArtifacts:function(t){var e=x.current;t&&(e=t);var r=x.nodes[e];return i(r)?n.toJS(r.artifacts.customArtifacts):[]},getLatestArtifact:function(t){var e=x.current;t&&(e=t);var r=x.nodes[e];if(i(r)){var o=r.artifacts.customArtifacts;return n.toJS(o[o.length-1])}return null},getAllAnnotation:function(t){var e=x.current;t&&(e=t);var r=x.nodes[e];return i(r)?n.toJS(r.artifacts.annotations):[]},getLatestAnnotation:function(t){var e=x.current;t&&(e=t);var r=x.nodes[e];if(i(r)){var o=r.artifacts.annotations;return n.toJS(o[o.length-1])}return null},undo:function(){var t=this.current;i(t)?p(x,t.parent):console.warn("Already at Root")},redo:function(t){void 0===t&&(t="latest");var e=this.current;if(0===e.children.length)console.warn("Already at latest node in this branch.");else{var n=e.children[e.children.length-1];"oldest"===t&&(n=e.children[0]),p(x,n)}},goBackOneStep:function(){this.undo()},goForwardOneStep:function(t){void 0===t&&(t="latest"),this.redo(t)},undoNonEphemeral:function(){this.goBackToNonEphemeral()},goBackToNonEphemeral:function(){var t=null,e=x.nodes[x.current];if(i(e)){for(t=e.parent;"Ephemeral"===x.nodes[t].actionType;){var n=x.nodes[t];if(!i(n))break;t=n.parent}p(x,t)}},redoNonEphemeral:function(t){void 0===t&&(t="latest"),this.goForwardToNonEphemeral(t)},goForwardToNonEphemeral:function(t){void 0===t&&(t="latest");var e=null,n=x.nodes[x.current];if(0===n.children.length)throw new Error("Already at latest node.");for(e=n.children["latest"===t?n.children.length-1:0];"Ephemeral"===x.nodes[e].actionType;){var r=x.nodes[e];if(0===r.children.length)break;e=r.children["latest"===t?r.children.length-1:0]}p(x,e)},reset:function(){p(x,x.root)},setBookmark:n.action("Bookmark Action",(function(t,e){x.nodes[t].bookmarked=e})),getBookmark:function(t){return x.nodes[t].bookmarked},getAllBookmarks:function(){return Object.entries(x.nodes).filter((function(t){return t[1].bookmarked})).map((function(t){return t[0]}))},exportState:function(n){void 0===n&&(n=!1);var r={},a=c(x,this.current),i=S(t);return n?Object.keys(i).forEach((function(t){var e,n=a[t];JSON.stringify(i[t])!==JSON.stringify(n)&&(r=o({},r,((e={})[t]=a[t],e)))})):r=a,e.compressToEncodedURIComponent(JSON.stringify(r))},importState:function(t){var n;n="string"==typeof t?JSON.parse(e.decompressFromEncodedURIComponent(t)||"{}"):o({},this.state,t),v(x,n)},exportProvenanceGraph:function(){return JSON.stringify(n.toJS(x))},importProvenanceGraph:n.action("Import Provenance Graph",(function(t){var e;e="string"==typeof t?JSON.parse(t):t,x.current=e.current,x.root=e.root,x.nodes=e.nodes})),getState:function(t){return b(c(x,"string"==typeof t?x.nodes[t]:t))},done:function(){if(l=!0,g){var t,e;if(!(null==(t=window)||null==(e=t.location)?void 0:e.href))throw new Error("loadFromUrl option can only be used in a browser environment");var n=new URL(window.location.href),r=new URLSearchParams(n.search).get("provState");if(!r)return;this.importState(r)}}}},t.isChildNode=i,t.isStateNode=a,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=trrack.umd.production.min.js.map
