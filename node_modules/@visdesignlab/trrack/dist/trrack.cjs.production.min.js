"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("lz-string"),e=require("mobx"),n=require("deep-diff");function r(){return(r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function o(t){return"parent"in t&&"state"in t}function a(t){return"parent"in t}function i(t,r){if(function(t){return"Root"===t.label}(r)||o(r))return e.toJS(r.state);var a=e.toJS(t.nodes[r.lastStateNode].state),i=JSON.parse(JSON.stringify(a));return r.diffs.forEach((function(t){n.applyChange(i,null,t)})),i}function c(t){var e=JSON.stringify(t);return JSON.parse(e,(function(t,e){return e?e.type&&"Set"===e.type?new Set(e.arr):e.type&&"Map"===e.type?new Map(Object.entries(e.obj)):e:e}))}function s(t){if(!t)return{};var n=JSON.stringify(e.toJS(t),(function(t,e){return e instanceof Set?{type:"Set",arr:Array.from(e)}:e instanceof Map?{type:"Map",obj:Object.fromEntries(e)}:e}));return JSON.parse(n)}function u(){return(new Date).getTime()}function d(){var t=(new Date).getTime();return t+=(new Date).valueOf(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)}))}function f(t,e,n,o,a,i){return{id:d(),label:n,metadata:r({createdOn:u(),eventType:a},i),artifacts:{annotations:[],customArtifacts:[]},parent:t,children:[],state:e,actionType:o,bookmarked:!1}}var l=e.action((function(t,e){var n=t.nodes[e];if(!n)throw new Error("Node with id: "+e+" does not exist");t.current=n.id})),p=e.action((function(t,e,o,c,s){var l=t,p=l.current,h=l.nodes[p],v=null,g=null;"diffs"in h?(v=i(l,l.nodes[h.lastStateNode]),g=h.lastStateNode):(v=i(l,h),g=h.id);var m=a(h),y=e.apply(o,s),S=y.stateSaveMode,x=y.actionType,b=y.label,w=y.eventType,O=y.meta,A=l.current,k=c(y.state),N=n.diff(v,k)||[];m&&Object.keys(v).length/2<N.length&&(m=!1);var J=(m=m&&"Diff"===S)?function(t,e,n,o,a,i,c){return{id:d(),label:e,metadata:r({createdOn:u(),eventType:i},c),artifacts:{annotations:[],customArtifacts:[]},parent:t,children:[],lastStateNode:a,diffs:n,actionType:o,bookmarked:!1}}(A,b,N,x,g,w,O):f(A,k,b,x,w,O);return l.nodes[J.id]=J,l.nodes[p].children.push(J.id),l.current=J.id,l.nodes[l.current]})),h=e.action((function(t,e){var n=f(t.current,e,"Import","Regular",null,{});t.nodes[n.id]=n,t.current=n.id}));e.configure({enforceActions:"always",isolateGlobalState:!0}),exports.createAction=function(t){var n,r,o="Regular",a="Diff",i={},c=function(){for(var c=arguments.length,s=new Array(c),u=0;u<c;u++)s[u]=arguments[u];return{apply:e.action((function(c,u){if(!n)throw new Error("Please specify a default label when you create the action");return u||(u=n),t.apply(void 0,[c].concat(s)),{state:e.toJS(c),label:u,stateSaveMode:a,actionType:o,eventType:r,meta:i}}))}};return c.setLabel=function(t){return n=t,this},c.setActionType=function(t){return o=t,this},c.saveStateMode=function(t){return a=t,this},c.setEventType=function(t){return r=t,this},c.setMetaData=function(t){return i=t,this},c},exports.getState=i,exports.initProvenance=function(n,o){void 0===o&&(o={});var f=r({loadFromUrl:!1,firebaseConfig:null,_serializer:void 0,_deserializer:void 0},o),v=!1,g=f.loadFromUrl,m=f._serializer,y=f._deserializer,S=void 0!==m?m:s,x=void 0!==y?y:c,b=function(t,n){var r,o,a;return e.makeAutoObservable((r=n(t),{nodes:(o={},o[(a={id:d(),label:"Root",metadata:{createdOn:u(),eventType:"Root"},children:[],state:r,actionType:"Regular",bookmarked:!1}).id]=a,o),root:a.id,current:a.id}))}(n,S),w=e.computed((function(){return x(i(b,b.nodes[b.current]))}));return g&&e.reaction((function(){return w.get()}),(function(e){var n=new URL(window.location.href),r=new URLSearchParams(n.search),o=t.compressToEncodedURIComponent(JSON.stringify(S(e)));r.set("provState",o),window.history.replaceState({},"",n.pathname+"?"+r)})),{get state(){return w.get()},get config(){return f},get graph(){return b},get current(){return b.nodes[b.current]},get root(){return b.nodes[b.root]},get usingDefaultSerializer(){return void 0===m&&void 0===y},apply:function(t,e){if(!v)throw new Error("Provenance setup not finished. Please call done function on provenance object after setting up any observers.)");p(b,t,w.get(),S,e)},addGlobalObserver:function(t){e.reaction((function(){return e.toJS(b)}),(function(e,n){var r="Any";Object.keys(e.nodes).length>Object.keys(n.nodes).length?r="NodeAdded":e.current!==n.current&&(r="CurrentChanged"),t(e,r)}))},addObserver:function(t,n){e.reaction((function(){return t(w.get())}),(function(t,e){return n(t,e)}))},goToNode:function(t){l(b,t)},addArtifact:e.action("Add Artifact Action",(function(t,e){var n=b.current;e&&(n=e);var r=b.nodes[n];a(r)&&r.artifacts.customArtifacts.push({timestamp:u(),artifact:t})})),addAnnotation:e.action("Add Annotation Action",(function(t,e){var n=b.current;e&&(n=e);var r=b.nodes[n];a(r)&&r.artifacts.annotations.push({timestamp:u(),annotation:t})})),getAllArtifacts:function(t){var n=b.current;t&&(n=t);var r=b.nodes[n];return a(r)?e.toJS(r.artifacts.customArtifacts):[]},getLatestArtifact:function(t){var n=b.current;t&&(n=t);var r=b.nodes[n];if(a(r)){var o=r.artifacts.customArtifacts;return e.toJS(o[o.length-1])}return null},getAllAnnotation:function(t){var n=b.current;t&&(n=t);var r=b.nodes[n];return a(r)?e.toJS(r.artifacts.annotations):[]},getLatestAnnotation:function(t){var n=b.current;t&&(n=t);var r=b.nodes[n];if(a(r)){var o=r.artifacts.annotations;return e.toJS(o[o.length-1])}return null},undo:function(){var t=this.current;a(t)?l(b,t.parent):console.warn("Already at Root")},redo:function(t){void 0===t&&(t="latest");var e=this.current;if(0===e.children.length)console.warn("Already at latest node in this branch.");else{var n=e.children[e.children.length-1];"oldest"===t&&(n=e.children[0]),l(b,n)}},goBackOneStep:function(){this.undo()},goForwardOneStep:function(t){void 0===t&&(t="latest"),this.redo(t)},undoNonEphemeral:function(){this.goBackToNonEphemeral()},goBackToNonEphemeral:function(){var t=null,e=b.nodes[b.current];if(a(e)){for(t=e.parent;"Ephemeral"===b.nodes[t].actionType;){var n=b.nodes[t];if(!a(n))break;t=n.parent}l(b,t)}},redoNonEphemeral:function(t){void 0===t&&(t="latest"),this.goForwardToNonEphemeral(t)},goForwardToNonEphemeral:function(t){void 0===t&&(t="latest");var e=null,n=b.nodes[b.current];if(0===n.children.length)throw new Error("Already at latest node.");for(e=n.children["latest"===t?n.children.length-1:0];"Ephemeral"===b.nodes[e].actionType;){var r=b.nodes[e];if(0===r.children.length)break;e=r.children["latest"===t?r.children.length-1:0]}l(b,e)},reset:function(){l(b,b.root)},setBookmark:e.action("Bookmark Action",(function(t,e){b.nodes[t].bookmarked=e})),getBookmark:function(t){return b.nodes[t].bookmarked},getAllBookmarks:function(){return Object.entries(b.nodes).filter((function(t){return t[1].bookmarked})).map((function(t){return t[0]}))},exportState:function(e){void 0===e&&(e=!1);var o={},a=i(b,this.current),c=S(n);return e?Object.keys(c).forEach((function(t){var e,n=a[t];JSON.stringify(c[t])!==JSON.stringify(n)&&(o=r({},o,((e={})[t]=a[t],e)))})):o=a,t.compressToEncodedURIComponent(JSON.stringify(o))},importState:function(e){var n;n="string"==typeof e?JSON.parse(t.decompressFromEncodedURIComponent(e)||"{}"):r({},this.state,e),h(b,n)},exportProvenanceGraph:function(){return JSON.stringify(e.toJS(b))},importProvenanceGraph:e.action("Import Provenance Graph",(function(t){var e;e="string"==typeof t?JSON.parse(t):t,b.current=e.current,b.root=e.root,b.nodes=e.nodes})),getState:function(t){return x(i(b,"string"==typeof t?b.nodes[t]:t))},done:function(){if(v=!0,g){var t,e;if(!(null==(t=window)||null==(e=t.location)?void 0:e.href))throw new Error("loadFromUrl option can only be used in a browser environment");var n=new URL(window.location.href),r=new URLSearchParams(n.search).get("provState");if(!r)return;this.importState(r)}}}},exports.isChildNode=a,exports.isStateNode=o;
//# sourceMappingURL=trrack.cjs.production.min.js.map
